<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rio Arcangelo</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-color: #1c1c1e;
            --card-bg: #2c2c2e;
            --text-primary: #ffffff;
            --text-secondary: #9e9e9e;
            --accent: #34b7f1;
            --danger: #ff453a;
            --success: #30d158;
            --warning: #ffd60a;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--tg-theme-bg-color, var(--bg-color));
            color: var(--tg-theme-text-color, var(--text-primary));
            padding: 15px;
            margin: 0;
            font-size: 14px;
        }

        /* Header com Placa */
        .header-placa {
            text-align: center;
            margin-bottom: 20px;
        }
        .placa-badge {
            background: #fff;
            color: #000;
            border: 2px solid #000;
            border-top: 4px solid #003399; /* Azul Mercosul */
            border-radius: 6px;
            padding: 5px 15px;
            font-size: 24px;
            font-weight: 800;
            display: inline-block;
            font-family: 'Consolas', monospace;
            letter-spacing: 2px;
        }

        /* Cart√µes */
        .card {
            background-color: var(--tg-theme-secondary-bg-color, var(--card-bg));
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        h2 {
            margin: 0 0 12px 0;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Linhas de Dados */
        .row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .row:last-child { border-bottom: none; }
        
        .label {
            color: var(--text-secondary);
            font-size: 0.9em;
            flex: 1;
        }
        
        .value {
            font-weight: 500;
            text-align: right;
            flex: 1.5;
            word-break: break-word;
        }

        /* Destaques Especiais */
        .alert-red { color: var(--danger); font-weight: bold; }
        .alert-green { color: var(--success); font-weight: bold; }
        
        /* Bot√£o Fechar */
        .btn-fechar {
            background-color: var(--tg-theme-button-color, var(--accent));
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            margin-top: 10px;
            transition: opacity 0.2s;
        }
        .btn-fechar:active { opacity: 0.8; }

        /* Loading */
        #loading { text-align: center; padding: 40px; color: var(--text-secondary); }
    </style>
</head>
<body>

    <div id="loading">Carregando dados...</div>
    <div id="content" style="display: none;"></div>

    <button class="btn-fechar" onclick="Telegram.WebApp.close()">Fechar Relat√≥rio</button>

    <script>
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();

        // 1. L√≥gica de Captura e Decodifica√ß√£o
        const params = new URLSearchParams(window.location.search);
        const rawData = params.get('dados');

        if (rawData) {
            try {
                // Decodifica Base64 -> JSON string -> Objeto JS
                const jsonStr = decodeURIComponent(escape(atob(rawData)));
                const dados = JSON.parse(jsonStr);
                renderizar(dados);
            } catch (e) {
                document.getElementById('loading').innerHTML = `‚ùå Erro ao ler dados: ${e.message}`;
            }
        } else {
            document.getElementById('loading').innerHTML = "‚ùå Nenhum dado recebido.";
        }

        // 2. Fun√ß√µes Auxiliares de Formata√ß√£o
        function fmtVal(val) {
            if (val === null || val === undefined || val === "") return null;
            if (val === true) return '<span class="alert-red">SIM</span>'; // Alerta para true (ex: roubo)
            if (val === false) return 'N√ÉO';
            return val;
        }

        function fmtDate(dateStr) {
            if (!dateStr || dateStr.length < 10) return null;
            // Pega s√≥ YYYY-MM-DD e inverte
            const [ano, mes, dia] = dateStr.substring(0, 10).split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function fmtDoc(doc) {
            if (!doc) return null;
            if (doc.length === 11) return doc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
            if (doc.length === 14) return doc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, "$1.$2.$3/$4-$5");
            return doc;
        }

        // 3. Fun√ß√£o Construtora de Linhas (ignora nulos)
        function row(label, value, isDate = false, isDoc = false) {
            let finalValue = value;
            if (isDate) finalValue = fmtDate(value);
            else if (isDoc) finalValue = fmtDoc(value);
            else finalValue = fmtVal(value);

            if (finalValue === null) return ''; // N√£o renderiza linha vazia

            return `
                <div class="row">
                    <span class="label">${label}</span>
                    <span class="value">${finalValue}</span>
                </div>`;
        }

        // 4. Renderiza√ß√£o Principal
        function renderizar(d) {
            const html = `
                <div class="header-placa">
                    <div class="placa-badge">${d.placa || 'SEM PLACA'}</div>
                    <div style="margin-top: 5px; opacity: 0.7;">${d.descricaoMarcaModelo || ''}</div>
                </div>

                <div class="card">
                    <h2>üöó Identifica√ß√£o</h2>
                    ${row('Renavam', d.codigoRenavam)}
                    ${row('Chassi', d.chassi)}
                    ${row('Motor', d.numeroMotor)}
                    ${row('Marca/Modelo', d.descricaoMarcaModelo)}
                    ${row('Ano Fab/Mod', (d.anoFabricacao || '?') + '/' + (d.anoModelo || '?'))}
                    ${row('Cor', d.descricaoCor)}
                    ${row('Combust√≠vel', d.descricaoCombustivel)}
                    ${row('Situa√ß√£o', d.situacao, false, false).replace('EM_CIRCULACAO', '<span class="alert-green">EM CIRCULA√á√ÉO</span>')}
                </div>

                <div class="card">
                    <h2>üìÑ Documenta√ß√£o</h2>
                    ${row('Licenciamento Pago', d.anoExercicioLicenciamentoPago)}
                    ${row('Emiss√£o CRLV', d.dataEmissaoCRLV, true)}
                    ${row('Emiss√£o CRV', d.dataEmissaoCrv, true)}
                    ${row('Munic√≠pio', d.descricaoMunicipioEmplacamento + ' - ' + d.ufJurisdicao)}
                </div>

                <div class="card">
                    <h2>üë§ Propriet√°rio</h2>
                    ${row('Nome', d.nomeProprietario)}
                    ${row('Documento', d.numeroIdentificacaoProprietario, false, true)}
                    ${row('Tipo', d.descricaoTipoProprietario)}
                </div>

                <div class="card">
                    <h2>‚ö†Ô∏è Restri√ß√µes e Alertas</h2>
                    ${row('Roubo/Furto', d.indicadorRouboFurto)}
                    ${row('Restri√ß√£o Judicial (Renajud)', d.indicadorRestricaoRenajud)}
                    ${row('Restri√ß√£o 1', d.descricaoRestricao1)}
                    ${row('Restri√ß√£o 2', d.descricaoRestricao2)}
                    ${row('Restri√ß√£o 3', d.descricaoRestricao3)}
                    ${row('Restri√ß√£o 4', d.descricaoRestricao4)}
                    ${row('Comunica√ß√£o Venda', d.indicadorComunicacaoVenda)}
                    ${row('Multas Renainf', d.indicadorMultaRenainf)}
                    ${row('Leil√£o', d.indicadorLeilao)}
                    ${row('Restri√ß√£o RFB', d.descricaoRestricaoRfb)}
                </div>

                <div class="card">
                    <h2>‚öôÔ∏è Ficha T√©cnica</h2>
                    ${row('Tipo Ve√≠culo', d.descricaoTipoVeiculo)}
                    ${row('Esp√©cie', d.descricaoEspecieVeiculo)}
                    ${row('Carroceria', d.descricaoTipoCarroceria)}
                    ${row('Categoria', d.descricaoCategoria)}
                    ${row('Pot√™ncia', d.potencia + ' cv')}
                    ${row('Cilindradas', d.cilindradas + ' cc')}
                    ${row('CMT', d.cmt)}
                    ${row('PBT', d.pbt)}
                    ${row('Eixos', d.qtdEixos)}
                    ${row('Lota√ß√£o', d.lotacao)}
                </div>

                ${d.procedencia !== 'NACIONAL' ? `
                <div class="card">
                    <h2>üö¢ Importa√ß√£o</h2>
                    ${row('Proced√™ncia', d.procedencia)}
                    ${row('DI', d.numeroDeclaracaoImportacao)}
                    ${row('Data Importa√ß√£o', d.dataDistImportacao, true)}
                    ${row('√ìrg√£o RFB', d.codigoOrgaoRfb)}
                </div>` : ''}
            `;

            document.getElementById('content').innerHTML = html;
            document.getElementById('content').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }
    </script>
</body>
</html>
